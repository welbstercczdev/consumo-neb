<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <meta name="theme-color" content="#0056b3">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Controle de Consumo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-primaria-escura: #0056b3;
            --cor-sucesso: #28a745;
            --cor-alerta: #ffc107;
            --cor-perigo: #dc3545;
            --cor-fundo: #f4f7f9;
            --cor-texto: #333;
            --cor-borda: #dee2e6;
            --borda-radius: 12px;
            --sombra: 0 4px 15px rgba(0, 0, 0, 0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            -webkit-tap-highlight-color: transparent;
        }
        .main-container { padding: 15px; padding-bottom: 170px; }
        .header { text-align: center; color: var(--cor-primaria-escura); margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .session-panel { background-color: #fff; padding: 20px; border-radius: var(--borda-radius); margin-bottom: 20px; box-shadow: var(--sombra); }
        .session-panel h2 { margin: 0 0 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .session-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); outline: none; }
        #lancamentos-container { display: grid; gap: 15px; }
        .lancamento-card { background-color: #fff; border-radius: var(--borda-radius); box-shadow: var(--sombra); border-left: 5px solid; transition: transform 0.2s ease-in-out; }
        .lancamento-card:hover { transform: translateY(-3px); }
        .card-body { padding: 15px; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.2rem; }
        .card-subtitle { margin: 0; color: #6c757d; font-size: 0.9rem; }
        .card-consumo { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .card-consumo input { text-align: center; font-weight: 600; font-size: 1.1rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--cor-fundo); border-top: 1px solid var(--cor-borda); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; color: #fff; }
        .status-pending { border-color: var(--cor-alerta); }
        .status-pending .status-badge { background-color: var(--cor-alerta); color: #333; }
        .status-ready { border-color: var(--cor-sucesso); }
        .status-ready .status-badge { background-color: var(--cor-sucesso); }
        .card-actions button { background: none; border: none; font-size: 1.3rem; padding: 5px; cursor: pointer; }
        .action-edit { color: var(--cor-alerta); }
        .action-complete { color: var(--cor-sucesso); }
        .action-delete { color: var(--cor-perigo); }
        .action-complete:disabled { color: #ccc; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--cor-primaria); color: #fff; border-radius: 50%; border: none; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,123,255,0.4); z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 2000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; padding: 25px; border-radius: var(--borda-radius); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.3rem; margin: 0; border: none; }
        .modal-header .close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-primary { background-color: var(--cor-primaria); color: #fff; }
        /* NOVO: Estilos para botões do modal de confirmação */
        .btn-danger { background-color: var(--cor-perigo); color: #fff; }
        .btn-secondary { background-color: #6c757d; color: #fff; }
        
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; padding: 15px; text-align: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.07); z-index: 999; }
        .btn-submit-all { background-color: var(--cor-sucesso); color: #fff; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 400px; }
        .error-message { color: var(--cor-perigo); font-weight: 500; text-align: center; height: 20px; font-size: 0.9rem; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #ddd; background-color: #fff; z-index: 2001; max-height: 150px; overflow-y: auto; list-style: none; padding: 0; margin: 0; box-sizing: border-box; border-radius: 8px; }
        .autocomplete-item { padding: 10px; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f0f0f0; }
        #toast-container { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 25px; color: #fff; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; }
        .toast.success { background-color: var(--cor-sucesso); }
        .toast.error { background-color: var(--cor-perigo); }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

<div class="main-container">
    <header class="header"><h1>Controle de Consumo</h1></header>
    <div class="session-panel">
        <h2><i class="fa-solid fa-calendar-days"></i> Sessão de Trabalho</h2>
        <div class="session-info">
            <div class="form-group"><label for="sessao-data">Data</label><input type="date" id="sessao-data"></div>
            <div class="form-group"><label for="sessao-equipe">Equipe</label><select id="sessao-equipe"><option value="">...</option></select></div>
        </div>
        <div class="error-message" id="session-error"></div>
    </div>
    <div id="lancamentos-container"></div>
</div>

<button class="fab" id="fab-add"><i class="fa-solid fa-plus"></i></button>

<!-- Modal de Adicionar/Editar -->
<div class="modal-overlay" id="add-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Novo Lançamento</h2><button class="close-btn" id="modal-close-btn">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group autocomplete-container">
                <label for="modal-aplicador">Aplicador</label>
                <input type="text" id="modal-aplicador" autocomplete="off">
                <ul id="modal-autocomplete-list" class="autocomplete-list" style="display: none;"></ul>
            </div>
            <div class="form-group"><label for="modal-atomizador">Atomizador</label><select id="modal-atomizador"><option value="">Selecione...</option></select></div>
            <div class="form-group"><label for="modal-gasolina">Gasolina (ml)</label><input type="number" id="modal-gasolina" min="0"></div>
            <div class="form-group"><label for="modal-inseticida">Inseticida (ml)</label><input type="number" id="modal-inseticida" min="0"></div>
            <div class="error-message" id="modal-error"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" id="modal-save-btn">Salvar Lançamento</button></div>
    </div>
</div>

<!-- NOVO: Modal de Confirmação -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="confirm-title">Confirmar Ação</h2>
        </div>
        <div class="modal-body">
            <p id="confirm-message">Você tem certeza?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button>
            <button class="btn btn-danger" id="confirm-ok-btn">Sim, remover</button>
        </div>
    </div>
</div>


<div class="bottom-actions"><button class="btn-submit-all" id="enviar-button" disabled><i class="fa-solid fa-paper-plane"></i> Enviar (0)</button></div>
<div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const DATA_KEY = 'consumo_Lancamentos_v7';
    const SESSION_KEY = 'consumo_Sessao_v7';
    // Constantes para os elementos da UI
    const lancamentosContainer = document.getElementById('lancamentos-container');
    const fabAdd = document.getElementById('fab-add');
    const enviarButton = document.getElementById('enviar-button');
    const sessionError = document.getElementById('session-error');
    const sessaoDataInput = document.getElementById('sessao-data');
    const sessaoEquipeSelect = document.getElementById('sessao-equipe');
    // Constantes para o modal de Adição
    const addModal = document.getElementById('add-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalError = document.getElementById('modal-error');
    const modalAplicador = document.getElementById('modal-aplicador');
    const modalAtomizador = document.getElementById('modal-atomizador');
    const modalGasolina = document.getElementById('modal-gasolina');
    const modalInseticida = document.getElementById('modal-inseticida');
    const modalAutocompleteList = document.getElementById('modal-autocomplete-list');
    
    // NOVO: Constantes para o modal de Confirmação
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

    let lancamentos = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
    let allMembros = [];

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    // NOVO: Função para exibir o modal de confirmação
    function showConfirm(message, onConfirm) {
        confirmMessage.textContent = message;
        confirmModal.style.display = 'flex';
        setTimeout(() => confirmModal.classList.add('visible'), 10);

        const hide = () => {
            confirmModal.classList.remove('visible');
            setTimeout(() => confirmModal.style.display = 'none', 300);
            confirmOkBtn.removeEventListener('click', handleOk);
            confirmCancelBtn.removeEventListener('click', hide);
        };
        
        const handleOk = () => {
            onConfirm();
            hide();
        };

        confirmOkBtn.addEventListener('click', handleOk);
        confirmCancelBtn.addEventListener('click', hide);
    }

    function renderLancamentos() {
        lancamentosContainer.innerHTML = '';
        if (lancamentos.length === 0) {
            lancamentosContainer.innerHTML = '<p style="text-align:center; color:#6c757d;">Nenhum lançamento ainda. Clique no botão + para começar.</p>';
        }
        lancamentos.sort((a, b) => a.aplicador.localeCompare(b.aplicador)).forEach((item, index) => {
            const card = document.createElement('div');
            card.className = `lancamento-card status-${item.status}`;
            card.dataset.index = index;
            const isCompletable = item.gasolina > 0 && item.inseticida > 0;
            const isReady = item.status === 'ready';
            let actionsHtml;
            if (isReady) {
                actionsHtml = `<button class="action-edit" data-action="edit" title="Editar"><i class="fa-solid fa-pencil"></i></button>`;
            } else {
                actionsHtml = `<button class="action-complete" data-action="complete" title="${isCompletable ? 'Marcar como Pronto' : 'Preencha os consumos'}" ${!isCompletable ? 'disabled' : ''}><i class="fa-solid fa-check"></i></button>`;
            }
            card.innerHTML = `
                <div class="card-body">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${item.aplicador}</h3>
                            <p class="card-subtitle">${item.equipe} • Atomizador ${item.atomizador}</p>
                        </div>
                    </div>
                    <div class="card-consumo">
                        <div class="form-group"><label>Gasolina (ml)</label><input type="number" class="card-input" data-field="gasolina" value="${item.gasolina || ''}" ${isReady ? 'disabled' : ''}></div>
                        <div class="form-group"><label>Inseticida (ml)</label><input type="number" class="card-input" data-field="inseticida" value="${item.inseticida || ''}" ${isReady ? 'disabled' : ''}></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="status-badge">${isReady ? 'Pronto' : 'Pendente'}</span>
                    <div class="card-actions">${actionsHtml}<button class="action-delete" data-action="delete" title="Excluir"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            `;
            lancamentosContainer.appendChild(card);
        });
        atualizarContadorEnvio();
        salvarDados();
    }
    
    const toggleModal = (show) => {
        if (show) { addModal.style.display = 'flex'; setTimeout(() => addModal.classList.add('visible'), 10); } 
        else { addModal.classList.remove('visible'); setTimeout(() => addModal.style.display = 'none', 300); }
    };
    fabAdd.addEventListener('click', () => toggleModal(true));
    modalCloseBtn.addEventListener('click', () => toggleModal(false));
    addModal.addEventListener('click', (e) => { if (e.target === addModal) toggleModal(false); });

    modalSaveBtn.addEventListener('click', () => {
        modalError.textContent = ''; sessionError.textContent = '';
        const sessaoData = sessaoDataInput.value;
        const sessaoEquipe = sessaoEquipeSelect.value;
        if (!sessaoData || !sessaoEquipe) {
            sessionError.textContent = 'Defina a Data e a Equipe principal.';
            showToast('Defina a Data e a Equipe!', 'error');
            toggleModal(false);
            return;
        }
        const aplicador = modalAplicador.value.trim();
        const atomizador = modalAtomizador.value;
        if (!aplicador || !atomizador) { modalError.textContent = 'Aplicador e Atomizador são obrigatórios.'; return; }
        const chaveUnica = `${sessaoData}-${sessaoEquipe}-${aplicador}-${atomizador}`;
        if (lancamentos.some(l => l.chave === chaveUnica)) { modalError.textContent = 'Este lançamento já foi adicionado.'; return; }
        const [year, month, day] = sessaoData.split('-');
        const gasolina = parseFloat(modalGasolina.value) || 0;
        const inseticida = parseFloat(modalInseticida.value) || 0;
        lancamentos.push({
            chave: chaveUnica, data: sessaoData, data_fmt: `${day}/${month}/${year}`, equipe: sessaoEquipe,
            aplicador, atomizador, gasolina, inseticida, status: (gasolina > 0 && inseticida > 0) ? 'ready' : 'pending'
        });
        [modalAplicador, modalGasolina, modalInseticida].forEach(i => i.value = '');
        modalAtomizador.value = '';
        toggleModal(false);
        renderLancamentos();
        showToast('Lançamento adicionado!', 'success');
    });

    lancamentosContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const cardElement = e.target.closest('.lancamento-card');
        if (!cardElement) return;
        const index = cardElement.dataset.index;
        const action = button.dataset.action;
        
        if (action === 'complete') {
            lancamentos[index].status = 'ready';
            renderLancamentos();
        }
        if (action === 'edit') {
            lancamentos[index].status = 'pending';
            renderLancamentos();
        }
        // MODIFICADO: Substituído confirm() pela função showConfirm()
        if (action === 'delete') {
            showConfirm('Remover este lançamento permanentemente?', () => {
                lancamentos.splice(index, 1);
                renderLancamentos();
                showToast('Lançamento removido.', 'success');
            });
        }
    });

    lancamentosContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('card-input')) {
            const cardElement = e.target.closest('.lancamento-card');
            if (!cardElement) return;
            const index = cardElement.dataset.index;
            lancamentos[index][e.target.dataset.field] = parseFloat(e.target.value) || 0;
            renderLancamentos();
        }
    });
    
    function atualizarContadorEnvio() {
        const prontos = lancamentos.filter(l => l.status === 'ready').length;
        enviarButton.disabled = prontos === 0;
        enviarButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Enviar (${prontos})`;
    }
    const salvarDados = () => localStorage.setItem(DATA_KEY, JSON.stringify(lancamentos));
    const salvarSessao = () => localStorage.setItem(SESSION_KEY, JSON.stringify({ data: sessaoDataInput.value, equipe: sessaoEquipeSelect.value }));
    const carregarSessao = () => {
        const sessao = JSON.parse(localStorage.getItem(SESSION_KEY)) || {};
        sessaoDataInput.value = sessao.data || new Date().toISOString().split('T')[0];
        sessaoEquipeSelect.value = sessao.equipe || '';
        salvarSessao();
    };
    sessaoDataInput.addEventListener('change', salvarSessao);
    sessaoEquipeSelect.addEventListener('change', salvarSessao);

    enviarButton.addEventListener('click', async () => {
        const prontosParaEnviar = lancamentos.filter(l => l.status === 'ready');
        if (prontosParaEnviar.length === 0) return;
        enviarButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
        enviarButton.disabled = true;
        
        try {
            for (const pedido of prontosParaEnviar) {
                const payload = { data: pedido.data_fmt, equipe: pedido.equipe, aplicador: pedido.aplicador, atomizador: pedido.atomizador, gasolina: pedido.gasolina, inseticida: pedido.inseticida };
                await enviarPedido(payload);
            }
            
            lancamentos = lancamentos.filter(l => l.status !== 'ready');
            renderLancamentos();
            showToast('Lançamentos enviados com sucesso!', 'success');

        } catch(error) {
            showToast(`Erro ao enviar: ${error.message}`, 'error');
            console.error("Erro no envio:", error);
        } finally {
            atualizarContadorEnvio();
        }
    });

    async function enviarPedido(pedido) {
        const apiUrl = 'https://script.google.com/macros/s/AKfycbwoQBltuMUVyyHCHLS2zomqEq0OBf50_jPwtaFqEhpFbSIosTbfbNu3fxs3S6AmYSVZTg/exec';
        const response = await fetch(apiUrl, { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams(pedido).toString() });
        if (!response.ok) throw new Error('Falha na resposta da API.');
        return response.text();
    }
    
    const carregarOpcoes = () => {
        fetch('https://script.google.com/macros/s/AKfycbwCWeO-4U-CTHi30do2CsnxpgqiEOybOm-8-kEXz4z68xU9gsIr0I7mloBV2RfrmD_9/exec')
            .then(r => r.json()).then(data => {
                sessaoEquipeSelect.innerHTML = '<option value="">Selecione...</option>';
                for (const equipe in data.equipes) sessaoEquipeSelect.add(new Option(equipe, equipe));
                allMembros = [...data.todos_membros].sort();
                carregarSessao();
            }).catch(e => {
                console.error("Erro ao carregar equipes:", e);
                showToast('Erro ao carregar dados.', 'error');
            });
        fetch('https://script.google.com/macros/s/AKfycbzK2AEiMd6qj0AQ78L5-cB9v8jiokYzpp2jCyU_yqzh2tLMguFNqXHLajb4yAApuSjFLA/exec')
            .then(r => r.json()).then(data => {
                modalAtomizador.innerHTML = '<option value="">Selecione...</option>';
                data.atomizadores.forEach(a => modalAtomizador.add(new Option(a, a)));
            }).catch(e => {
                console.error("Erro ao carregar atomizadores:", e);
                showToast('Erro ao carregar dados.', 'error');
            });
    };
    
    modalAplicador.addEventListener('input', function () {
        const inputValue = modalAplicador.value.toLowerCase();
        modalAutocompleteList.innerHTML = '';
        modalAutocompleteList.style.display = 'none';

        if (inputValue.length > 0) {
            const filteredMembros = allMembros.filter(m => m.toLowerCase().includes(inputValue));
            if (filteredMembros.length > 0) {
                filteredMembros.forEach(membro => {
                    const li = document.createElement('li');
                    li.textContent = membro;
                    li.className = 'autocomplete-item';
                    li.addEventListener('click', function () {
                        modalAplicador.value = membro;
                        modalAutocompleteList.style.display = 'none';
                    });
                    modalAutocompleteList.appendChild(li);
                });
                modalAutocompleteList.style.display = 'block';
            }
        }
    });

    document.addEventListener('click', function (event) {
        if (!event.target.closest('.autocomplete-container')) {
            modalAutocompleteList.style.display = 'none';
        }
    });

    carregarOpcoes();
    renderLancamentos();
});

// Registro do PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            console.log('Service worker registrado.', reg);
        }).catch(err => {
            console.error('Erro no registro do Service worker:', err);
        });
    });
}
</script>

</body>
</html>
