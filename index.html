<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0056b3">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Controle de Consumo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        /* [SEUS ESTILOS CSS PERMANECEM OS MESMOS - NENHUMA ALTERAÇÃO NECESSÁRIA] */
        :root {
            --cor-primaria: #007bff;
            --cor-primaria-escura: #0056b3;
            --cor-sucesso: #28a745;
            --cor-alerta: #ffc107;
            --cor-perigo: #dc3545;
            --cor-fundo: #f4f7f9;
            --cor-texto: #333;
            --cor-borda: #dee2e6;
            --borda-radius: 12px;
            --sombra: 0 4px 15px rgba(0, 0, 0, 0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            -webkit-tap-highlight-color: transparent;
        }
        
        #app-container, #access-denied-container, #verifying-container { display: none; }
        .full-page-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
        }
        .full-page-container h1 { color: var(--cor-primaria-escura); margin-bottom: 10px; }
        .full-page-container p { margin-top: 0; color: #6c757d; }
        .btn-login {
            background-color: #fff; color: #444; border: 1px solid #ddd; padding: 12px 24px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-login:hover { background-color: #f5f5f5; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .btn-login img { width: 24px; height: 24px; }

        .user-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #fff; border-bottom: 1px solid var(--cor-borda); margin-bottom: 15px;
        }
        .user-info { font-size: 0.9rem; color: var(--cor-texto); font-weight: 500; }
        .btn-logout { background: none; border: none; color: var(--cor-perigo); font-size: 1rem; cursor: pointer; font-weight: bold; }
        
        /* O resto dos seus estilos permanecem os mesmos */
        .main-container { padding: 15px; padding-bottom: 170px; }
        /* ... etc ... */
    </style>
</head>
<body>

<!-- Tela de Login -->
<div id="login-container" class="full-page-container">
    <h1>Controle de Consumo</h1>
    <p>Faça login com sua conta Google para continuar</p>
    <button class="btn-login" id="login-btn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
        Entrar com Google
    </button>
</div>

<!-- Tela de "Verificando" (opcional, mas melhora a experiência) -->
<div id="verifying-container" class="full-page-container">
    <i class="fa-solid fa-spinner fa-spin fa-2x" style="color: var(--cor-primaria);"></i>
    <p style="margin-top: 20px;">Verificando autenticação...</p>
</div>

<!-- Tela de Acesso Negado -->
<div id="access-denied-container" class="full-page-container">
    <i class="fa-solid fa-user-lock fa-3x" style="color: var(--cor-perigo); margin-bottom: 20px;"></i>
    <h1>Acesso Negado</h1>
    <p>Seu e-mail <strong id="denied-email"></strong> não tem permissão para usar esta aplicação.</p>
    <p>Por favor, contate o administrador ou tente com outra conta.</p>
    <button class="btn-logout" id="logout-btn-denied">Sair</button>
</div>

<!-- Aplicação Principal (O conteúdo aqui dentro não muda) -->
<div id="app-container">
    <div class="user-header">
        <div class="user-info" id="user-info-display"></div>
        <button class="btn-logout" id="logout-btn">Sair <i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
    <!-- O resto do seu HTML da aplicação vai aqui -->
</div>

<div id="toast-container"></div>

<script type="module">
    // ATUALIZADO: signInWithRedirect foi importado em vez de signInWithPopup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, onAuthStateChanged, signOut, getIdToken, signInWithRedirect } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDfbqxZETPoNmB-cxNzx5JNp_A2QkCvXVI",
        authDomain: "consumo-neb.firebaseapp.com",
        projectId: "consumo-neb",
        storageBucket: "consumo-neb.appspot.com",
        messagingSenderId: "748729779853",
        appId: "1:748729779853:web:b1b34484c3dc3b133144c4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const API_URL = 'https://script.google.com/macros/s/AKfycbzE_KwNKNN7W3uj9g_yqyuM3kv_zxaZvnBLb_ev8mUv45dPdwwarkgMRLQwfduW9N1VRQ/exec';
    
    let appInitialized = false;

    function showToast(message, type = 'success') { /* sua função showToast aqui */ }

    document.addEventListener('DOMContentLoaded', function () {
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const accessDeniedContainer = document.getElementById('access-denied-container');
        const verifyingContainer = document.getElementById('verifying-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtnDenied = document.getElementById('logout-btn-denied');
        const userInfoDisplay = document.getElementById('user-info-display');
        const deniedEmail = document.getElementById('denied-email');
        
        const showScreen = (screen) => {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'none';
            accessDeniedContainer.style.display = 'none';
            verifyingContainer.style.display = 'none';
            screen.style.display = screen.id.includes('container') ? 'flex' : 'block';
            if (screen.id === 'app-container') screen.style.display = 'block';
        };

        // ATUALIZADO: A função de login agora usa signInWithRedirect
        const loginWithGoogle = () => {
            showScreen(verifyingContainer); // Mostra "verificando" para o usuário
            const provider = new GoogleAuthProvider();
            signInWithRedirect(auth, provider); // Inicia o redirecionamento
        };

        const logout = () => {
            signOut(auth);
        };

        loginBtn.addEventListener('click', loginWithGoogle);
        logoutBtn.addEventListener('click', logout);
        logoutBtnDenied.addEventListener('click', logout);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuário está logado (ou acabou de voltar do redirecionamento).
                // Mostra a tela de verificação enquanto checamos a autorização.
                showScreen(verifyingContainer);
                try {
                    const idToken = await getIdToken(user);
                    const response = await fetch(`${API_URL}?token=${idToken}`);
                    if (!response.ok) throw new Error('Falha ao conectar com o servidor de autorização.');
                    const data = await response.json();

                    if (data.isAuthorized) {
                        showScreen(appContainer);
                        userInfoDisplay.textContent = `Logado como: ${user.email}`;
                        if (!appInitialized) {
                            initApp();
                        }
                    } else {
                        deniedEmail.textContent = user.email;
                        showScreen(accessDeniedContainer);
                    }
                } catch (error) {
                    console.error("Erro ao verificar autorização:", error);
                    showToast(error.message, "error");
                    // Em caso de erro, desloga o usuário para que ele possa tentar novamente.
                    logout();
                }
            } else {
                // Usuário está deslogado.
                showScreen(loginContainer);
                appInitialized = false;
            }
        });
        
        function initApp() {
            // [TODO O CÓDIGO DA SUA APLICAÇÃO VEM AQUI DENTRO]
            // Nenhuma alteração é necessária aqui. O código da sua aplicação
            // (renderLancamentos, carregarOpcoes, etc.) permanece o mesmo.
            appInitialized = true;
        };
    });
</script>

</body>
</html>
