<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <meta name="theme-color" content="#0056b3">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Controle de Consumo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-primaria-escura: #0056b3;
            --cor-sucesso: #28a745;
            --cor-alerta: #ffc107;
            --cor-perigo: #dc3545;
            --cor-fundo: #f4f7f9;
            --cor-texto: #333;
            --cor-borda: #dee2e6;
            --borda-radius: 12px;
            --sombra: 0 4px 15px rgba(0, 0, 0, 0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            -webkit-tap-highlight-color: transparent;
        }
        .main-container { padding: 15px; padding-bottom: 170px; }
        .header { text-align: center; color: var(--cor-primaria-escura); margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .session-panel { background-color: #fff; padding: 20px; border-radius: var(--borda-radius); margin-bottom: 20px; box-shadow: var(--sombra); }
        .session-panel h2 { margin: 0 0 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .session-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); outline: none; }
        #lancamentos-container { display: grid; gap: 15px; }
        .lancamento-card { background-color: #fff; border-radius: var(--borda-radius); box-shadow: var(--sombra); border-left: 5px solid; transition: transform 0.2s ease-in-out; }
        .card-body { padding: 15px; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.2rem; }
        .card-subtitle { margin: 0; color: #6c757d; font-size: 0.9rem; }
        .card-consumo { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .card-consumo input { text-align: center; font-weight: 600; font-size: 1.1rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--cor-fundo); border-top: 1px solid var(--cor-borda); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; color: #fff; }
        .status-pending { border-color: var(--cor-alerta); }
        .status-pending .status-badge { background-color: var(--cor-alerta); color: #333; }
        .status-ready { border-color: var(--cor-sucesso); }
        .status-ready .status-badge { background-color: var(--cor-sucesso); }
        .card-actions button { background: none; border: none; font-size: 1.3rem; padding: 5px; cursor: pointer; }
        .action-edit { color: var(--cor-alerta); }
        .action-complete { color: var(--cor-sucesso); }
        .action-delete { color: var(--cor-perigo); }
        .action-complete:disabled { color: #ccc; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--cor-primaria); color: #fff; border-radius: 50%; border: none; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,123,255,0.4); z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 2000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; padding: 25px; border-radius: var(--borda-radius); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.3rem; margin: 0; border: none; }
        .modal-header .close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-primary { background-color: var(--cor-primaria); color: #fff; }
        .btn-danger { background-color: var(--cor-perigo); color: #fff; }
        .btn-secondary { background-color: #6c757d; color: #fff; }
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; padding: 15px; text-align: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.07); z-index: 999; }
        .btn-submit-all { background-color: var(--cor-sucesso); color: #fff; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 400px; }
        .error-message { color: var(--cor-perigo); font-weight: 500; text-align: center; min-height: 20px; font-size: 0.9rem; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #ddd; background-color: #fff; z-index: 2001; max-height: 150px; overflow-y: auto; list-style: none; padding: 0; margin: 0; box-sizing: border-box; border-radius: 8px; }
        .autocomplete-item { padding: 10px; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f0f0f0; }
        #toast-container { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 25px; color: #fff; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; }
        .toast.success { background-color: var(--cor-sucesso); }
        .toast.error { background-color: var(--cor-perigo); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .auth-container { width: 100%; max-width: 400px; margin: 40px auto; padding: 20px; }
        .auth-view { display: none; }
        .auth-view.visible { display: block; }
        #app-view-container { display: none; }
        #app-view-container.visible { display: block; }
        .form-link { display: block; text-align: right; margin-top: 10px; color: var(--cor-primaria); font-size: 0.9rem; cursor: pointer; }
        .header-user { font-size: 0.9rem; color: #6c757d; display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px; margin-bottom: -10px; }
        .header-user i { cursor: pointer; font-size: 1.2rem; }
        .header-user #change-password-main-btn { color: var(--cor-primaria-escura); }
        .header-user #logout-btn { color: var(--cor-perigo); }
    </style>
</head>
<body>

<!-- Container para as telas de Autenticação -->
<div id="auth-container">
    <!-- Tela de Login -->
    <div id="login-view" class="auth-view auth-container">
        <header class="header"><h1>Acessar Sistema</h1></header>
        <div class="session-panel">
            <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" autocomplete="email"></div>
            <div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" autocomplete="current-password"></div>
            <div class="error-message" id="login-error"></div>
            <button class="btn btn-primary" id="login-btn" style="width:100%; margin-top:15px;">Entrar</button>
            <span class="form-link" id="goto-forgot-password">Esqueceu a senha?</span>
        </div>
    </div>
    
    <!-- Tela de Redefinição de Senha -->
    <div id="forgot-password-view" class="auth-view auth-container">
        <header class="header"><h1>Redefinir Senha</h1></header>
        <div class="session-panel">
            <p style="text-align: center; margin-bottom: 20px;">Insira seu e-mail para enviarmos um link de redefinição.</p>
            <div class="form-group"><label for="forgot-email">Email</label><input type="email" id="forgot-email" autocomplete="email"></div>
            <div class="error-message" id="forgot-error"></div>
            <button class="btn btn-primary" id="send-reset-btn" style="width:100%; margin-top:15px;">Enviar Link</button>
            <span class="form-link" id="goto-login">Voltar para o Login</span>
        </div>
    </div>

    <!-- Tela de Alteração de Senha (Primeiro Acesso) -->
    <div id="change-password-view" class="auth-view auth-container">
        <header class="header"><h1>Alterar Senha</h1></header>
        <div class="session-panel">
            <p style="text-align: center; margin-bottom: 20px;">Por segurança, você deve alterar sua senha no primeiro acesso.</p>
            <div class="form-group"><label for="new-password">Nova Senha (mínimo 6 caracteres)</label><input type="password" id="new-password" autocomplete="new-password"></div>
            <div class="error-message" id="change-password-error"></div>
            <button class="btn btn-primary" id="change-password-btn" style="width:100%; margin-top:15px;">Salvar Nova Senha</button>
        </div>
    </div>
</div>


<!-- Wrapper para toda a aplicação principal -->
<div id="app-view-container">
    <div class="main-container">
        <header class="header">
            <h1>Controle de Consumo</h1>
            <div class="header-user">
                <span id="user-email-display"></span>
                <i class="fa-solid fa-key" id="change-password-main-btn" title="Alterar Senha"></i>
                <i class="fa-solid fa-right-from-bracket" id="logout-btn" title="Sair"></i>
            </div>
        </header>
        <div class="session-panel">
            <h2><i class="fa-solid fa-calendar-days"></i> Sessão de Trabalho</h2>
            <div class="session-info">
                <div class="form-group"><label for="sessao-data">Data</label><input type="date" id="sessao-data"></div>
                <div class="form-group"><label for="sessao-equipe">Equipe</label><select id="sessao-equipe"><option value="">...</option></select></div>
            </div>
            <div class="error-message" id="session-error"></div>
        </div>
        <div id="lancamentos-container"></div>
    </div>

    <button class="fab" id="fab-add"><i class="fa-solid fa-plus"></i></button>

    <!-- Modal de Adicionar/Editar -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Lançamento</h2><button class="close-btn" data-modal-id="add-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group autocomplete-container">
                    <label for="modal-aplicador">Aplicador</label>
                    <input type="text" id="modal-aplicador" autocomplete="off">
                    <ul id="modal-autocomplete-list" class="autocomplete-list" style="display: none;"></ul>
                </div>
                <div class="form-group"><label for="modal-atomizador">Atomizador</label><select id="modal-atomizador"><option value="">Selecione...</option></select></div>
                <div class="form-group"><label for="modal-gasolina">Gasolina (ml)</label><input type="number" id="modal-gasolina" min="0"></div>
                <div class="form-group"><label for="modal-inseticida">Inseticida (ml)</label><input type="number" id="modal-inseticida" min="0"></div>
                <div class="error-message" id="modal-error"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-btn" data-modal-id="add-modal">Cancelar</button>
                <button class="btn btn-primary" id="modal-save-btn">Salvar Lançamento</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="confirm-title">Confirmar Ação</h2></div>
            <div class="modal-body"><p id="confirm-message">Você tem certeza?</p></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button>
                <button class="btn btn-danger" id="confirm-ok-btn">Sim, remover</button>
            </div>
        </div>
    </div>

    <!-- Modal para alterar senha do usuário logado -->
    <div class="modal-overlay" id="manage-password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Alterar Minha Senha</h2>
                <button class="close-btn" data-modal-id="manage-password-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="current-password">Senha Atual</label>
                    <input type="password" id="current-password" autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="manage-new-password">Nova Senha</label>
                    <input type="password" id="manage-new-password" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirmar Nova Senha</label>
                    <input type="password" id="confirm-new-password" autocomplete="new-password">
                </div>
                <div class="error-message" id="manage-password-error"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-btn" data-modal-id="manage-password-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-new-password-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div class="bottom-actions"><button class="btn-submit-all" id="enviar-button" disabled><i class="fa-solid fa-paper-plane"></i> Enviar (0)</button></div>
</div>


<div id="toast-container"></div>

<!-- Scripts do Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// SUAS CREDENCIAIS DO FIREBASE
// Substitua pela NOVA apiKey que você regenerou por segurança!
const firebaseConfig = {
    apiKey: "AIzaSyDfbqxZETPoNmB-cxNzx5JNp_A2QkCvXVI",
    authDomain: "consumo-neb.firebaseapp.com",
    projectId: "consumo-neb",
    storageBucket: "consumo-neb.appspot.com",
    messagingSenderId: "748729779853",
    appId: "1:748729779853:web:b1b34484c3dc3b133144c4"
};

// Inicialização do Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();


document.addEventListener('DOMContentLoaded', function () {
    const DATA_KEY_PREFIX = 'consumo_Lancamentos_v9_';
    const SESSION_KEY_PREFIX = 'consumo_Sessao_v9_';
    let DATA_KEY = '';
    let SESSION_KEY = '';
    let lancamentos = [];
    let allMembros = [];

    // --- CONSTANTES DOS ELEMENTOS DE UI ---
    // Autenticação
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-view-container');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailDisplay = document.getElementById('user-email-display');
    const gotoForgotPasswordBtn = document.getElementById('goto-forgot-password');
    const gotoLoginBtn = document.getElementById('goto-login');
    const sendResetBtn = document.getElementById('send-reset-btn');
    const changePasswordBtn = document.getElementById('change-password-btn');
    const changePasswordMainBtn = document.getElementById('change-password-main-btn');

    // Aplicação Principal
    const lancamentosContainer = document.getElementById('lancamentos-container');
    const fabAdd = document.getElementById('fab-add');
    const enviarButton = document.getElementById('enviar-button');
    const sessionError = document.getElementById('session-error');
    const sessaoDataInput = document.getElementById('sessao-data');
    const sessaoEquipeSelect = document.getElementById('sessao-equipe');
    
    // Modal de Adição
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalError = document.getElementById('modal-error');
    const modalAplicador = document.getElementById('modal-aplicador');
    const modalAtomizador = document.getElementById('modal-atomizador');
    const modalGasolina = document.getElementById('modal-gasolina');
    const modalInseticida = document.getElementById('modal-inseticida');
    const modalAutocompleteList = document.getElementById('modal-autocomplete-list');
    
    // Modal de Confirmação
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

    // Modal de Alteração de Senha (Logado)
    const managePasswordModal = document.getElementById('manage-password-modal');
    const saveNewPasswordBtn = document.getElementById('save-new-password-btn');
    const managePasswordError = document.getElementById('manage-password-error');

    
    // --- LÓGICA DE AUTENTICAÇÃO ---

    function showAuthView(viewId) {
        document.querySelectorAll('.auth-view').forEach(v => v.classList.remove('visible'));
        document.getElementById(viewId).classList.add('visible');
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            const creationTime = new Date(user.metadata.creationTime).getTime();
            const lastSignInTime = new Date(user.metadata.lastSignInTime).getTime();
            
            if (lastSignInTime - creationTime < 10000) { // Margem de 10s para primeiro acesso
                authContainer.style.display = 'block';
                appContainer.classList.remove('visible');
                showAuthView('change-password-view');
            } else {
                authContainer.style.display = 'none';
                appContainer.classList.add('visible');
                userEmailDisplay.textContent = user.email;
                initializeUserData(user.uid);
            }
        } else {
            authContainer.style.display = 'block';
            appContainer.classList.remove('visible');
            showAuthView('login-view');
        }
    });

    function initializeUserData(uid) {
        DATA_KEY = `${DATA_KEY_PREFIX}${uid}`;
        SESSION_KEY = `${SESSION_KEY_PREFIX}${uid}`;
        lancamentos = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
        carregarSessao();
        carregarOpcoes();
        renderLancamentos();
    }

    loginBtn.addEventListener('click', () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');
        errorDiv.textContent = '';
        loginBtn.textContent = 'Entrando...';
        loginBtn.disabled = true;

        auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
                errorDiv.textContent = 'Email ou senha inválidos.';
                console.error("Erro de login:", error.message);
            })
            .finally(() => {
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;
            });
    });

    logoutBtn.addEventListener('click', () => auth.signOut());
    gotoForgotPasswordBtn.addEventListener('click', () => showAuthView('forgot-password-view'));
    gotoLoginBtn.addEventListener('click', () => showAuthView('login-view'));

    sendResetBtn.addEventListener('click', () => {
        const email = document.getElementById('forgot-email').value;
        const errorDiv = document.getElementById('forgot-error');
        errorDiv.textContent = '';
        sendResetBtn.disabled = true;

        auth.sendPasswordResetEmail(email)
            .then(() => {
                showToast('Link de redefinição enviado para seu e-mail!', 'success');
                showAuthView('login-view');
            })
            .catch(error => {
                errorDiv.textContent = 'Erro ao enviar. Verifique o e-mail.';
                console.error("Erro de redefinição:", error.message);
            })
            .finally(() => sendResetBtn.disabled = false);
    });

    changePasswordBtn.addEventListener('click', () => {
        const newPassword = document.getElementById('new-password').value;
        const errorDiv = document.getElementById('change-password-error');
        errorDiv.textContent = '';
        if (newPassword.length < 6) {
            errorDiv.textContent = 'A senha deve ter no mínimo 6 caracteres.';
            return;
        }

        const user = auth.currentUser;
        changePasswordBtn.disabled = true;
        user.updatePassword(newPassword)
            .then(() => {
                showToast('Senha alterada! Faça login com a nova senha.', 'success');
                auth.signOut();
            })
            .catch(error => {
                errorDiv.textContent = 'Erro ao alterar a senha.';
                console.error("Erro ao alterar senha:", error.message);
            })
            .finally(() => changePasswordBtn.disabled = false);
    });

    saveNewPasswordBtn.addEventListener('click', async () => {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('manage-new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        managePasswordError.textContent = '';

        if (!currentPassword || !newPassword || !confirmPassword) { managePasswordError.textContent = 'Todos os campos são obrigatórios.'; return; }
        if (newPassword.length < 6) { managePasswordError.textContent = 'A nova senha deve ter no mínimo 6 caracteres.'; return; }
        if (newPassword !== confirmPassword) { managePasswordError.textContent = 'As novas senhas não coincidem.'; return; }

        const user = auth.currentUser;
        if (!user) { showToast('Sessão inválida. Faça login novamente.', 'error'); return; }

        saveNewPasswordBtn.disabled = true;
        saveNewPasswordBtn.textContent = 'Salvando...';

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
            await user.reauthenticateWithCredential(credential);
            await user.updatePassword(newPassword);
            showToast('Senha alterada com sucesso!', 'success');
            toggleGenericModal('manage-password-modal', false);
        } catch (error) {
            console.error("Erro ao alterar senha:", error);
            managePasswordError.textContent = error.code === 'auth/wrong-password' ? 'A senha atual está incorreta.' : 'Ocorreu um erro. Tente novamente.';
        } finally {
            saveNewPasswordBtn.disabled = false;
            saveNewPasswordBtn.textContent = 'Salvar Alterações';
        }
    });

    // --- FUNÇÕES DA APLICAÇÃO ---

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    function showConfirm(message, onConfirm) {
        confirmMessage.textContent = message;
        confirmModal.style.display = 'flex';
        setTimeout(() => confirmModal.classList.add('visible'), 10);

        const hide = () => {
            confirmModal.classList.remove('visible');
            setTimeout(() => confirmModal.style.display = 'none', 300);
            confirmOkBtn.removeEventListener('click', handleOk);
            confirmCancelBtn.removeEventListener('click', hide);
        };
        const handleOk = () => { onConfirm(); hide(); };
        confirmOkBtn.addEventListener('click', handleOk);
        confirmCancelBtn.addEventListener('click', hide);
    }

    const toggleGenericModal = (modalId, show) => {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const hide = () => {
            modal.classList.remove('visible');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        };

        if (show) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
            // Adiciona listeners de fechamento
            modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', hide, { once: true }));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) hide();
            }, { once: true });
        } else {
            hide();
        }
    };
    
    fabAdd.addEventListener('click', () => toggleGenericModal('add-modal', true));
    changePasswordMainBtn.addEventListener('click', () => {
        managePasswordModal.querySelectorAll('input').forEach(input => input.value = '');
        managePasswordError.textContent = '';
        toggleGenericModal('manage-password-modal', true);
    });

    function renderLancamentos() {
        lancamentosContainer.innerHTML = '';
        if (lancamentos.length === 0) {
            lancamentosContainer.innerHTML = '<p style="text-align:center; color:#6c757d;">Nenhum lançamento ainda. Clique no botão + para começar.</p>';
        }
        lancamentos.sort((a,b) => a.aplicador.localeCompare(b.aplicador)).forEach((item, index) => {
            const card = document.createElement('div');
            card.className = `lancamento-card status-${item.status}`;
            card.dataset.index = index;
            const isCompletable = item.gasolina > 0 && item.inseticida > 0;
            const isReady = item.status === 'ready';
            let actionsHtml = isReady ? 
                `<button class="action-edit" data-action="edit" title="Editar"><i class="fa-solid fa-pencil"></i></button>` :
                `<button class="action-complete" data-action="complete" title="${isCompletable ? 'Marcar como Pronto' : 'Preencha os consumos'}" ${!isCompletable ? 'disabled' : ''}><i class="fa-solid fa-check"></i></button>`;
            card.innerHTML = `
                <div class="card-body">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${item.aplicador}</h3>
                            <p class="card-subtitle">${item.equipe} • Atomizador ${item.atomizador}</p>
                        </div>
                    </div>
                    <div class="card-consumo">
                        <div class="form-group"><label>Gasolina (ml)</label><input type="number" class="card-input" data-field="gasolina" value="${item.gasolina || ''}" ${isReady ? 'disabled' : ''}></div>
                        <div class="form-group"><label>Inseticida (ml)</label><input type="number" class="card-input" data-field="inseticida" value="${item.inseticida || ''}" ${isReady ? 'disabled' : ''}></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="status-badge">${isReady ? 'Pronto' : 'Pendente'}</span>
                    <div class="card-actions">${actionsHtml}<button class="action-delete" data-action="delete" title="Excluir"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            `;
            lancamentosContainer.appendChild(card);
        });
        atualizarContadorEnvio();
        salvarDados();
    }
    
    modalSaveBtn.addEventListener('click', () => {
        modalError.textContent = ''; sessionError.textContent = '';
        const sessaoData = sessaoDataInput.value;
        const sessaoEquipe = sessaoEquipeSelect.value;
        if (!sessaoData || !sessaoEquipe) { showToast('Defina a Data e a Equipe principal!', 'error'); return; }
        const aplicador = modalAplicador.value.trim();
        const atomizador = modalAtomizador.value;
        if (!aplicador || !atomizador) { modalError.textContent = 'Aplicador e Atomizador são obrigatórios.'; return; }
        const chaveUnica = `${sessaoData}-${sessaoEquipe}-${aplicador}-${atomizador}`;
        if (lancamentos.some(l => l.chave === chaveUnica)) { modalError.textContent = 'Este lançamento já foi adicionado.'; return; }
        const [year, month, day] = sessaoData.split('-');
        const gasolina = parseFloat(modalGasolina.value) || 0;
        const inseticida = parseFloat(modalInseticida.value) || 0;
        lancamentos.push({
            chave: chaveUnica, data: sessaoData, data_fmt: `${day}/${month}/${year}`, equipe: sessaoEquipe,
            aplicador, atomizador, gasolina, inseticida, status: (gasolina > 0 && inseticida > 0) ? 'ready' : 'pending'
        });
        [modalAplicador, modalGasolina, modalInseticida].forEach(i => i.value = '');
        modalAtomizador.value = '';
        toggleGenericModal('add-modal', false);
        renderLancamentos();
        showToast('Lançamento adicionado!', 'success');
    });

    lancamentosContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const cardElement = e.target.closest('.lancamento-card');
        const index = cardElement.dataset.index;
        const action = button.dataset.action;
        
        if (action === 'complete') { lancamentos[index].status = 'ready'; }
        if (action === 'edit') { lancamentos[index].status = 'pending'; }
        if (action === 'delete') {
            showConfirm('Remover este lançamento permanentemente?', () => {
                lancamentos.splice(index, 1);
                renderLancamentos();
                showToast('Lançamento removido.', 'success');
            });
            return; // Evita re-renderização desnecessária
        }
        renderLancamentos();
    });

    lancamentosContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('card-input')) {
            const cardElement = e.target.closest('.lancamento-card');
            const index = cardElement.dataset.index;
            lancamentos[index][e.target.dataset.field] = parseFloat(e.target.value) || 0;
            renderLancamentos();
        }
    });
    
    function atualizarContadorEnvio() {
        const prontos = lancamentos.filter(l => l.status === 'ready').length;
        enviarButton.disabled = prontos === 0;
        enviarButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Enviar (${prontos})`;
    }
    const salvarDados = () => localStorage.setItem(DATA_KEY, JSON.stringify(lancamentos));
    const salvarSessao = () => localStorage.setItem(SESSION_KEY, JSON.stringify({ data: sessaoDataInput.value, equipe: sessaoEquipeSelect.value }));
    const carregarSessao = () => {
        const sessao = JSON.parse(localStorage.getItem(SESSION_KEY)) || {};
        sessaoDataInput.value = sessao.data || new Date().toISOString().split('T')[0];
        sessaoEquipeSelect.value = sessao.equipe || '';
        salvarSessao();
    };
    sessaoDataInput.addEventListener('change', salvarSessao);
    sessaoEquipeSelect.addEventListener('change', salvarSessao);

    enviarButton.addEventListener('click', async () => {
        const currentUser = auth.currentUser;
        if (!currentUser) { showToast('Sessão expirada. Faça login.', 'error'); return; }

        const prontosParaEnviar = lancamentos.filter(l => l.status === 'ready');
        if (prontosParaEnviar.length === 0) return;

        enviarButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
        enviarButton.disabled = true;
        
        try {
            for (const pedido of prontosParaEnviar) {
                const payload = { ...pedido, usuarioLogado: currentUser.email };
                await enviarPedido(payload);
            }
            lancamentos = lancamentos.filter(l => l.status !== 'ready');
            renderLancamentos();
            showToast('Lançamentos enviados com sucesso!', 'success');
        } catch(error) {
            showToast(`Erro ao enviar: ${error.message}`, 'error');
            console.error("Erro no envio:", error);
        } finally {
            atualizarContadorEnvio();
        }
    });

    async function enviarPedido(pedido) {
        const apiUrl = 'https://script.google.com/macros/s/AKfycbwoQBltuMUVyyHCHLS2zomqEq0OBf50_jPwtaFqEhpFbSIosTbfbNu3fxs3S6AmYSVZTg/exec'; // URL do seu Google Apps Script
        const response = await fetch(apiUrl, { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams(pedido).toString() });
        if (!response.ok) throw new Error('Falha na resposta da API.');
        return response.text();
    }
    
    const carregarOpcoes = () => {
        fetch('https://script.google.com/macros/s/AKfycbwCWeO-4U-CTHi30do2CsnxpgqiEOybOm-8-kEXz4z68xU9gsIr0I7mloBV2RfrmD_9/exec')
            .then(r => r.json()).then(data => {
                sessaoEquipeSelect.innerHTML = '<option value="">Selecione...</option>';
                for (const equipe in data.equipes) sessaoEquipeSelect.add(new Option(equipe, equipe));
                allMembros = [...data.todos_membros].sort();
                carregarSessao();
            }).catch(e => { console.error("Erro ao carregar equipes:", e); showToast('Erro ao carregar dados.', 'error'); });
        fetch('https://script.google.com/macros/s/AKfycbzK2AEiMd6qj0AQ78L5-cB9v8jiokYzpp2jCyU_yqzh2tLMguFNqXHLajb4yAApuSjFLA/exec')
            .then(r => r.json()).then(data => {
                modalAtomizador.innerHTML = '<option value="">Selecione...</option>';
                data.atomizadores.forEach(a => modalAtomizador.add(new Option(a, a)));
            }).catch(e => { console.error("Erro ao carregar atomizadores:", e); showToast('Erro ao carregar dados.', 'error'); });
    };
    
    modalAplicador.addEventListener('input', function () {
        const inputValue = modalAplicador.value.toLowerCase();
        modalAutocompleteList.innerHTML = '';
        modalAutocompleteList.style.display = 'none';
        if (inputValue.length > 0) {
            const filteredMembros = allMembros.filter(m => m.toLowerCase().includes(inputValue));
            if (filteredMembros.length > 0) {
                filteredMembros.forEach(membro => {
                    const li = document.createElement('li');
                    li.textContent = membro;
                    li.className = 'autocomplete-item';
                    li.addEventListener('click', function () {
                        modalAplicador.value = membro;
                        modalAutocompleteList.style.display = 'none';
                    });
                    modalAutocompleteList.appendChild(li);
                });
                modalAutocompleteList.style.display = 'block';
            }
        }
    });

    document.addEventListener('click', function (event) {
        if (!event.target.closest('.autocomplete-container')) {
            modalAutocompleteList.style.display = 'none';
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                console.log('Service worker registrado.', reg);
            }).catch(err => {
                console.error('Erro no registro do Service worker:', err);
            });
        });
    }
});
</script>

</body>
</html>
