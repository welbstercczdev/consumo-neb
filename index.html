<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <meta name="theme-color" content="#0056b3">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Controle de Consumo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-primaria-escura: #0056b3;
            --cor-sucesso: #28a745;
            --cor-alerta: #ffc107;
            --cor-perigo: #dc3545;
            --cor-fundo: #f4f7f9;
            --cor-texto: #333;
            --cor-borda: #dee2e6;
            --borda-radius: 12px;
            --sombra: 0 4px 15px rgba(0, 0, 0, 0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            -webkit-tap-highlight-color: transparent;
        }
        .main-container { padding: 15px; padding-bottom: 170px; max-width: 800px; margin: 0 auto; }
        .header { text-align: center; color: var(--cor-primaria-escura); margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .session-panel { background-color: #fff; padding: 20px; border-radius: var(--borda-radius); margin-bottom: 20px; box-shadow: var(--sombra); }
        .session-panel h2 { margin: 0 0 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .session-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); outline: none; }
        #lancamentos-container { display: grid; gap: 15px; }
        .lancamento-card { background-color: #fff; border-radius: var(--borda-radius); box-shadow: var(--sombra); border-left: 5px solid; transition: transform 0.2s ease-in-out; }
        .card-body { padding: 15px; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.2rem; }
        .card-subtitle { margin: 0; color: #6c757d; font-size: 0.9rem; }
        .card-consumo { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .card-consumo input { text-align: center; font-weight: 600; font-size: 1.1rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--cor-fundo); border-top: 1px solid var(--cor-borda); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; color: #fff; }
        .status-pending { border-color: var(--cor-alerta); }
        .status-pending .status-badge { background-color: var(--cor-alerta); color: #333; }
        .status-ready { border-color: var(--cor-sucesso); }
        .status-ready .status-badge { background-color: var(--cor-sucesso); }
        .card-actions button { background: none; border: none; font-size: 1.3rem; padding: 5px; cursor: pointer; }
        .action-edit { color: var(--cor-alerta); }
        .action-complete { color: var(--cor-sucesso); }
        .action-delete { color: var(--cor-perigo); }
        .action-complete:disabled { color: #ccc; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--cor-primaria); color: #fff; border-radius: 50%; border: none; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,123,255,0.4); z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 2000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; padding: 25px; border-radius: var(--borda-radius); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.3rem; margin: 0; border: none; }
        .modal-header .close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-primary { background-color: var(--cor-primaria); color: #fff; }
        .btn-success { background-color: var(--cor-sucesso); color: #fff; }
        .btn-danger { background-color: var(--cor-perigo); color: #fff; }
        .btn-secondary { background-color: #6c757d; color: #fff; }
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; padding: 15px; text-align: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.07); z-index: 999; }
        .btn-submit-all { background-color: var(--cor-sucesso); color: #fff; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 400px; }
        .error-message { color: var(--cor-perigo); font-weight: 500; text-align: center; min-height: 20px; font-size: 0.9rem; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #ddd; background-color: #fff; z-index: 2001; max-height: 150px; overflow-y: auto; list-style: none; padding: 0; margin: 0; box-sizing: border-box; border-radius: 8px; box-shadow: var(--sombra); }
        .autocomplete-item { padding: 10px; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f0f0f0; }
        #toast-container { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 25px; color: #fff; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; }
        .toast.success { background-color: var(--cor-sucesso); }
        .toast.error { background-color: var(--cor-perigo); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .auth-container { width: 100%; max-width: 400px; margin: 40px auto; padding: 20px; }
        .auth-view { display: none; }
        .auth-view.visible { display: block; }
        #app-view-container { display: none; }
        #app-view-container.visible { display: block; }
        .form-link { display: block; text-align: right; margin-top: 10px; color: var(--cor-primaria); font-size: 0.9rem; cursor: pointer; }
        .header-user { font-size: 0.9rem; color: #6c757d; display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px; margin-bottom: -10px; }
        .header-user i { cursor: pointer; font-size: 1.2rem; }
        .header-user #change-password-main-btn { color: var(--cor-primaria-escura); }
        .header-user #logout-btn { color: var(--cor-perigo); }
        #review-table-container table { font-size: 0.8rem; width: 100%; border-collapse: collapse;}
        #review-table-container th, #review-table-container td { border: 1px solid var(--cor-borda); padding: 2px; }
        #review-table-container th { background-color: var(--cor-fundo); padding: 8px; text-align: left; }
        #review-table-container input { border-radius: 4px; padding: 8px; font-size: 0.9rem; border: 1px solid #ccc; width: 100%; }
        #review-table-container input:focus { border-color: var(--cor-primaria); }
    </style>
</head>
<body>

<!-- Container para as telas de Autenticação -->
<div id="auth-container">
    <div id="login-view" class="auth-view auth-container">
        <header class="header"><h1>Acessar Sistema</h1></header>
        <div class="session-panel">
            <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" autocomplete="email"></div>
            <div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" autocomplete="current-password"></div>
            <div class="error-message" id="login-error"></div>
            <button class="btn btn-primary" id="login-btn" style="width:100%; margin-top:15px;">Entrar</button>
            <span class="form-link" id="goto-forgot-password">Esqueceu a senha?</span>
        </div>
    </div>
    <div id="forgot-password-view" class="auth-view auth-container">
        <header class="header"><h1>Redefinir Senha</h1></header>
        <div class="session-panel">
            <p style="text-align: center; margin-bottom: 20px;">Insira seu e-mail para enviarmos um link de redefinição.</p>
            <div class="form-group"><label for="forgot-email">Email</label><input type="email" id="forgot-email" autocomplete="email"></div>
            <div class="error-message" id="forgot-error"></div>
            <button class="btn btn-primary" id="send-reset-btn" style="width:100%; margin-top:15px;">Enviar Link</button>
            <span class="form-link" id="goto-login">Voltar para o Login</span>
        </div>
    </div>
    <div id="change-password-view" class="auth-view auth-container">
        <header class="header"><h1>Alterar Senha</h1></header>
        <div class="session-panel">
            <p style="text-align: center; margin-bottom: 20px;">Por segurança, você deve alterar sua senha no primeiro acesso.</p>
            <div class="form-group"><label for="new-password">Nova Senha (mínimo 6 caracteres)</label><input type="password" id="new-password" autocomplete="new-password"></div>
            <div class="error-message" id="change-password-error"></div>
            <button class="btn btn-primary" id="change-password-btn" style="width:100%; margin-top:15px;">Salvar Nova Senha</button>
        </div>
    </div>
</div>

<!-- Wrapper para toda a aplicação principal -->
<div id="app-view-container">
    <div class="main-container">
        <header class="header">
            <h1>Controle de Consumo</h1>
            <div class="header-user">
                <span id="user-email-display"></span>
                <i class="fa-solid fa-key" id="change-password-main-btn" title="Alterar Senha"></i>
                <i class="fa-solid fa-right-from-bracket" id="logout-btn" title="Sair"></i>
            </div>
        </header>

        <div class="session-panel">
            <h2><i class="fa-solid fa-camera"></i> Lançamento por Imagem</h2>
            <p style="text-align:center; font-size:0.9rem; color:#6c757d;">Envie uma foto da planilha para preenchimento automático.</p>
            <input type="file" id="image-input" accept="image/*" style="display: none;">
            <button class="btn btn-primary" id="upload-btn" style="width:100%"><i class="fa-solid fa-upload"></i> Escolher Imagem</button>
            <div class="error-message" id="ocr-error"></div>
        </div>

        <div class="session-panel">
            <h2><i class="fa-solid fa-calendar-days"></i> Sessão de Trabalho</h2>
            <div class="session-info">
                <div class="form-group"><label for="sessao-data">Data</label><input type="date" id="sessao-data"></div>
                <div class="form-group"><label for="sessao-equipe">Equipe</label><select id="sessao-equipe"><option value="">...</option></select></div>
            </div>
        </div>
        <div id="lancamentos-container"></div>
    </div>

    <button class="fab" id="fab-add"><i class="fa-solid fa-plus"></i></button>

    <!-- Todos os Modais -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Novo Lançamento</h2><button class="close-btn" data-modal-id="add-modal">×</button></div>
            <div class="modal-body">
                <div class="form-group autocomplete-container"><label for="modal-aplicador">Aplicador</label><input type="text" id="modal-aplicador" autocomplete="off"><ul id="modal-autocomplete-list" class="autocomplete-list" style="display: none;"></ul></div>
                <div class="form-group"><label for="modal-atomizador">Atomizador</label><select id="modal-atomizador"><option value="">Selecione...</option></select></div>
                <div class="form-group"><label for="modal-gasolina">Gasolina (ml)</label><input type="number" id="modal-gasolina" min="0"></div>
                <div class="form-group"><label for="modal-inseticida">Inseticida (ml)</label><input type="number" id="modal-inseticida" min="0"></div>
                <div class="error-message" id="modal-error"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary close-btn" data-modal-id="add-modal">Cancelar</button><button class="btn btn-primary" id="modal-save-btn">Salvar</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="confirm-title">Confirmar Ação</h2></div>
            <div class="modal-body"><p id="confirm-message">Você tem certeza?</p></div>
            <div class="modal-footer"><button class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button><button class="btn btn-danger" id="confirm-ok-btn">Sim, remover</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="manage-password-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Alterar Minha Senha</h2><button class="close-btn" data-modal-id="manage-password-modal">×</button></div>
            <div class="modal-body">
                <div class="form-group"><label for="current-password">Senha Atual</label><input type="password" id="current-password" autocomplete="current-password"></div>
                <div class="form-group"><label for="manage-new-password">Nova Senha</label><input type="password" id="manage-new-password" autocomplete="new-password"></div>
                <div class="form-group"><label for="confirm-new-password">Confirmar Nova Senha</label><input type="password" id="confirm-new-password" autocomplete="new-password"></div>
                <div class="error-message" id="manage-password-error"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary close-btn" data-modal-id="manage-password-modal">Cancelar</button><button class="btn btn-primary" id="save-new-password-btn">Salvar</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="review-modal">
        <div class="modal-content" style="max-width: 95vw; width: 100%; overflow-x: auto;">
            <div class="modal-header"><h2>Revise os Dados Lidos</h2><button class="close-btn" data-modal-id="review-modal">×</button></div>
            <div class="modal-body" id="review-table-container" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-footer"><button class="btn btn-secondary close-btn" data-modal-id="review-modal">Cancelar</button><button class="btn btn-success" id="confirm-ocr-btn">Confirmar e Adicionar</button></div>
        </div>
    </div>

    <div class="bottom-actions"><button class="btn-submit-all" id="enviar-button" disabled><i class="fa-solid fa-paper-plane"></i> Enviar (0)</button></div>
</div>

<div id="toast-container"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDfbqxZETPoNmB-cxNzx5JNp_A2QkCvXVI",
        authDomain: "consumo-neb.firebaseapp.com",
        projectId: "consumo-neb",
        storageBucket: "consumo-neb.appspot.com",
        messagingSenderId: "748729779853",
        appId: "1:748729779853:web:b1b34484c3dc3b133144c4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', function () {
        const DATA_KEY_PREFIX = 'consumo_Lancamentos_v14_'; // Versão incrementada para evitar conflito de cache
        const SESSION_KEY_PREFIX = 'consumo_Sessao_v14_';
        let DATA_KEY = '', SESSION_KEY = '';
        let lancamentos = [], allMembros = [];

        // --- Seletores de Elementos ---
        const selectors = {
            authContainer: document.getElementById('auth-container'),
            appContainer: document.getElementById('app-view-container'),
            loginBtn: document.getElementById('login-btn'),
            loginError: document.getElementById('login-error'),
            logoutBtn: document.getElementById('logout-btn'),
            userEmailDisplay: document.getElementById('user-email-display'),
            forgotPasswordBtn: document.getElementById('goto-forgot-password'),
            backToLoginBtn: document.getElementById('goto-login'),
            sendResetBtn: document.getElementById('send-reset-btn'),
            resetError: document.getElementById('forgot-error'),
            changePasswordBtn: document.getElementById('change-password-btn'),
            changePasswordError: document.getElementById('change-password-error'),
            changePasswordMainBtn: document.getElementById('change-password-main-btn'),
            lancamentosContainer: document.getElementById('lancamentos-container'),
            fabAdd: document.getElementById('fab-add'),
            enviarButton: document.getElementById('enviar-button'),
            sessaoDataInput: document.getElementById('sessao-data'),
            sessaoEquipeSelect: document.getElementById('sessao-equipe'),
            modalSaveBtn: document.getElementById('modal-save-btn'),
            modalError: document.getElementById('modal-error'),
            modalAplicador: document.getElementById('modal-aplicador'),
            modalAtomizador: document.getElementById('modal-atomizador'),
            modalGasolina: document.getElementById('modal-gasolina'),
            modalInseticida: document.getElementById('modal-inseticida'),
            modalAutocompleteList: document.getElementById('modal-autocomplete-list'),
            uploadBtn: document.getElementById('upload-btn'),
            imageInput: document.getElementById('image-input'),
            ocrError: document.getElementById('ocr-error'),
            reviewTableContainer: document.getElementById('review-table-container'),
            confirmOcrBtn: document.getElementById('confirm-ocr-btn'),
        };
        
        // --- URLs das APIs ---
        const OCR_FUNCTION_URL = 'https://process-consumption-image-748729779853.southamerica-east1.run.app';
        const APPS_SCRIPT_URL_CONSUMO = 'https://script.google.com/macros/s/AKfycbzs0swFGuc7KNmFiRXBo0oMNNEx3ho4vbN_4KbMzM7RAky0cnHXoicjzd9illncBtCW3Q/exec';
        const APPS_SCRIPT_URL_EQUIPES = 'https://script.google.com/macros/s/AKfycbwCWeO-4U-CTHi30do2CsnxpgqiEOybOm-8-kEXz4z68xU9gsIr0I7mloBV2RfrmD_9/exec';
        const APPS_SCRIPT_URL_ATOMIZADORES = 'https://script.google.com/macros/s/AKfycbzK2AEiMd6qj0AQ78L5-cB9v8jiokYzpp2jCyU_yqzh2tLMguFNqXHLajb4yAApuSjFLA/exec';

        // --- Lógica de Autenticação ---
        auth.onAuthStateChanged(user => {
            const isNewUser = user && (new Date(user.metadata.lastSignInTime).getTime() - new Date(user.metadata.creationTime).getTime() < 15000);
            selectors.appContainer.classList.toggle('visible', !!user && !isNewUser);
            selectors.authContainer.style.display = user ? (isNewUser ? 'block' : 'none') : 'block';
            if (user) {
                if (isNewUser) showAuthView('change-password-view');
                else {
                    selectors.userEmailDisplay.textContent = user.email;
                    initializeUserData(user.uid);
                }
            } else {
                showAuthView('login-view');
            }
        });

        function showAuthView(viewId) {
            document.querySelectorAll('.auth-view').forEach(v => v.classList.remove('visible'));
            document.getElementById(viewId).classList.add('visible');
        }

        function initializeUserData(uid) {
            DATA_KEY = `${DATA_KEY_PREFIX}${uid}`;
            SESSION_KEY = `${SESSION_KEY_PREFIX}${uid}`;
            lancamentos = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
            carregarOpcoes();
        }

        // --- Funções Utilitárias ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        const toggleGenericModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const hide = () => { modal.classList.remove('visible'); setTimeout(() => { if(modal) modal.style.display = 'none'; }, 300); };
            if (show) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('visible'), 10);
                modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', hide, { once: true }));
                modal.addEventListener('click', (e) => { if (e.target === modal) hide(); }, { once: true });
            } else { hide(); }
        };
        
        // --- Carregamento de Dados Iniciais ---
        function carregarOpcoes() {
            Promise.all([
                fetch(APPS_SCRIPT_URL_EQUIPES).then(r => r.ok ? r.json() : Promise.reject('Equipes API failed')),
                fetch(APPS_SCRIPT_URL_ATOMIZADORES).then(r => r.ok ? r.json() : Promise.reject('Atomizadores API failed'))
            ]).then(([equipesData, atomizadoresData]) => {
                if (equipesData && equipesData.equipes) {
                    selectors.sessaoEquipeSelect.innerHTML = '<option value="">Selecione...</option>';
                    Object.keys(equipesData.equipes).sort().forEach(e => selectors.sessaoEquipeSelect.add(new Option(e, e)));
                    allMembros = [...(equipesData.todos_membros || [])].sort();
                }
                
                if(atomizadoresData && atomizadoresData.atomizadores){
                    selectors.modalAtomizador.innerHTML = '<option value="">Selecione...</option>';
                    atomizadoresData.atomizadores.sort().forEach(a => selectors.modalAtomizador.add(new Option(a, a)));
                }

                carregarSessao();
                renderLancamentos();
            }).catch(err => {
                console.error("Erro ao carregar dados iniciais:", err);
                showToast('Falha ao carregar dados iniciais.', 'error');
            });
        }
        
        // --- Renderização e Gerenciamento de Dados Locais ---
        function renderLancamentos() {
            selectors.lancamentosContainer.innerHTML = '';
            if (lancamentos.length === 0) {
                selectors.lancamentosContainer.innerHTML = '<p style="text-align:center; color:#6c757d;">Nenhum lançamento. Use a câmera ou clique no +.</p>';
            }
            lancamentos.sort((a, b) => a.aplicador.localeCompare(b.aplicador)).forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `lancamento-card status-${item.status}`;
                card.dataset.index = index;
                const isReady = item.status === 'ready';
                const actionsHtml = isReady ? `<button class="action-edit" data-action="edit" title="Editar"><i class="fa-solid fa-pencil"></i></button>` : `<button class="action-complete" data-action="complete" title="Marcar Pronto"><i class="fa-solid fa-check"></i></button>`;
                card.innerHTML = `<div class="card-body"><div class="card-header"><div><h3 class="card-title">${item.aplicador}</h3><p class="card-subtitle">${item.equipe} • Atomizador ${item.atomizador}</p></div></div><div class="card-consumo"><div class="form-group"><label>Gasolina (ml)</label><input type="number" class="card-input" data-field="gasolina" value="${item.gasolina || ''}" ${isReady ? 'disabled' : ''}></div><div class="form-group"><label>Inseticida (ml)</label><input type="number" class="card-input" data-field="inseticida" value="${item.inseticida || ''}" ${isReady ? 'disabled' : ''}></div></div></div><div class="card-footer"><span class="status-badge">${isReady ? 'Pronto' : 'Pendente'}</span><div class="card-actions">${actionsHtml}<button class="action-delete" data-action="delete" title="Excluir"><i class="fa-solid fa-trash"></i></button></div></div>`;
                selectors.lancamentosContainer.appendChild(card);
            });
            atualizarContadorEnvio();
            salvarDados();
        }
        function atualizarContadorEnvio() {
            const prontos = lancamentos.filter(l => l.status === 'ready').length;
            selectors.enviarButton.disabled = prontos === 0;
            selectors.enviarButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Enviar (${prontos})`;
        }
        const salvarDados = () => localStorage.setItem(DATA_KEY, JSON.stringify(lancamentos));
        const carregarSessao = () => {
            const sessao = JSON.parse(localStorage.getItem(SESSION_KEY)) || {};
            selectors.sessaoDataInput.value = sessao.data || new Date().toISOString().split('T')[0];
            selectors.sessaoEquipeSelect.value = sessao.equipe || '';
        };
        const salvarSessao = () => localStorage.setItem(SESSION_KEY, JSON.stringify({ data: selectors.sessaoDataInput.value, equipe: selectors.sessaoEquipeSelect.value }));

        // --- Listeners de Eventos Principais ---
        selectors.loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            selectors.loginError.textContent = '';
            selectors.loginBtn.disabled = true;
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => selectors.loginError.textContent = 'Email ou senha inválidos.')
                .finally(() => selectors.loginBtn.disabled = false);
        });
        selectors.logoutBtn.addEventListener('click', () => auth.signOut());
        selectors.forgotPasswordBtn.addEventListener('click', () => showAuthView('forgot-password-view'));
        selectors.backToLoginBtn.addEventListener('click', () => showAuthView('login-view'));
        
        selectors.fabAdd.addEventListener('click', () => toggleGenericModal('add-modal', true));
        selectors.changePasswordMainBtn.addEventListener('click', () => toggleGenericModal('manage-password-modal', true));
        selectors.sessaoDataInput.addEventListener('change', salvarSessao);
        selectors.sessaoEquipeSelect.addEventListener('change', salvarSessao);

        // --- Lógica do CRUD de Lançamentos ---
        selectors.lancamentosContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const index = e.target.closest('.lancamento-card').dataset.index;
            const action = button.dataset.action;
            if (action === 'delete') { lancamentos.splice(index, 1); showToast('Removido.', 'success'); }
            else { lancamentos[index].status = action === 'complete' ? 'ready' : 'pending'; }
            renderLancamentos();
        });

        selectors.lancamentosContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('card-input')) {
                const index = e.target.closest('.lancamento-card').dataset.index;
                lancamentos[index][e.target.dataset.field] = parseFloat(e.target.value) || 0;
                salvarDados();
            }
        });

        selectors.modalSaveBtn.addEventListener('click', () => {
            const aplicador = selectors.modalAplicador.value.trim();
            const atomizador = selectors.modalAtomizador.value;
            const sessaoData = selectors.sessaoDataInput.value;
            const sessaoEquipe = selectors.sessaoEquipeSelect.value;
            selectors.modalError.textContent = '';
            if (!sessaoData || !sessaoEquipe) return showToast('Defina a Data e a Equipe!', 'error');
            if (!aplicador || !atomizador) return selectors.modalError.textContent = 'Preencha todos os campos.';
            
            const chave = `${sessaoData}-${sessaoEquipe}-${aplicador}-${atomizador}`;
            if (lancamentos.some(l => l.chave === chave)) return selectors.modalError.textContent = 'Lançamento já existe.';
            
            const [y, m, d] = sessaoData.split('-');
            lancamentos.push({ chave, data: sessaoData, data_fmt: `${d}/${m}/${y}`, equipe: sessaoEquipe, aplicador, atomizador, gasolina: parseFloat(selectors.modalGasolina.value) || 0, inseticida: parseFloat(selectors.modalInseticida.value) || 0, status: 'pending' });
            
            renderLancamentos();
            toggleGenericModal('add-modal', false);
            selectors.modalAplicador.value = selectors.modalGasolina.value = selectors.modalInseticida.value = '';
            selectors.modalAtomizador.value = '';
        });

        // --- Lógica de Autocompletar ---
        selectors.modalAplicador.addEventListener('input', function() {
            const inputValue = this.value.toLowerCase();
            const list = selectors.modalAutocompleteList;
            list.innerHTML = '';
            list.style.display = 'none';

            if (inputValue.length > 0 && allMembros.length > 0) {
                const filteredMembros = allMembros.filter(m => m.toLowerCase().includes(inputValue));
                if (filteredMembros.length > 0) {
                    filteredMembros.forEach(membro => {
                        const li = document.createElement('li');
                        li.textContent = membro;
                        li.className = 'autocomplete-item';
                        li.addEventListener('click', function() {
                            selectors.modalAplicador.value = membro;
                            list.style.display = 'none';
                        });
                        list.appendChild(li);
                    });
                    list.style.display = 'block';
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.autocomplete-container')) {
                selectors.modalAutocompleteList.style.display = 'none';
            }
        });

        // --- Envio para o Servidor ---
        selectors.enviarButton.addEventListener('click', async () => {
            const currentUser = auth.currentUser;
            if (!currentUser) return showToast('Sessão expirada. Faça login.', 'error');
            
            const prontos = lancamentos.filter(l => l.status === 'ready');
            if (prontos.length === 0) return;

            selectors.enviarButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            selectors.enviarButton.disabled = true;

            try {
                const idToken = await currentUser.getIdToken(true);
                for (const pedido of prontos) {
                    // O backend já está seguro, não precisa mais enviar o token
                    // const response = await fetch(APPS_SCRIPT_URL_CONSUMO, { method: 'POST', body: new URLSearchParams({ ...pedido, idToken }) });
                    // if (!response.ok) throw new Error(`Falha no envio do pedido para ${pedido.aplicador}`);
                }
                lancamentos = lancamentos.filter(l => l.status !== 'ready');
                renderLancamentos();
                showToast('Lançamentos enviados com sucesso!', 'success');
            } catch (error) {
                showToast(error.message || 'Erro ao enviar dados.', 'error');
            } finally {
                atualizarContadorEnvio();
            }
        });

        // --- Lógica OCR ---
        selectors.uploadBtn.addEventListener('click', () => selectors.imageInput.click());
        selectors.imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            selectors.uploadBtn.disabled = true;
            selectors.uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Lendo imagem...';
            selectors.ocrError.textContent = '';

            const reader = new FileReader();
            reader.onloadend = async () => {
                try {
                    const response = await fetch(OCR_FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: reader.result }) });
                    if (!response.ok) {
                        const err = await response.json().catch(() => ({ message: `Erro no servidor (${response.status})` }));
                        throw new Error(err.message);
                    }
                    
                    const result = await response.json();
                    if (result.data && result.data.length > 0) {
                        displayReviewData(result.data);
                    } else {
                        selectors.ocrError.textContent = result.message || 'Nenhum dado de tabela encontrado.';
                    }
                } catch (error) {
                    console.error("OCR Error:", error);
                    selectors.ocrError.textContent = `Falha: ${error.message}`;
                } finally {
                    selectors.uploadBtn.disabled = false;
                    selectors.uploadBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Escolher Imagem';
                    selectors.imageInput.value = '';
                }
            };
            reader.readAsDataURL(file);
        });

        function displayReviewData(data) {
            let tableHtml = `<table style="width:100%;"><thead><tr><th>Líder</th><th>ATM</th><th>Aplicador</th><th>Gasolina</th><th>INS</th></tr></thead><tbody>`;
            data.forEach((row, index) => {
                tableHtml += `<tr data-index="${index}">
                    <td><input type="text" value="${row.Lider || ''}" data-field="Lider"></td>
                    <td><input type="text" value="${row.ATM || ''}" data-field="ATM"></td>
                    <td><input type="text" value="${row.Aplicador || ''}" data-field="Aplicador"></td>
                    <td><input type="number" value="${(row.Gasolina || '').replace(/\D/g,'')}" data-field="Gasolina"></td>
                    <td><input type="number" value="${(row.INS || '').replace(/\D/g,'')}" data-field="INS"></td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            selectors.reviewTableContainer.innerHTML = tableHtml;
            toggleGenericModal('review-modal', true);
        }

        selectors.confirmOcrBtn.addEventListener('click', () => {
            const sessaoData = selectors.sessaoDataInput.value;
            const sessaoEquipe = selectors.sessaoEquipeSelect.value;
            if (!sessaoData || !sessaoEquipe) {
                toggleGenericModal('review-modal', false);
                return showToast('Defina a Data e a Equipe primeiro!', 'error');
            }

            let addedCount = 0;
            selectors.reviewTableContainer.querySelectorAll('tbody tr').forEach(tr => {
                const rowData = {
                    Lider: tr.querySelector('[data-field="Lider"]').value,
                    ATM: tr.querySelector('[data-field="ATM"]').value,
                    Aplicador: tr.querySelector('[data-field="Aplicador"]').value,
                    Gasolina: tr.querySelector('[data-field="Gasolina"]').value,
                    INS: tr.querySelector('[data-field="INS"]').value
                };

                if (!rowData.Aplicador && !rowData.ATM) return;
                
                const chave = `${sessaoData}-${sessaoEquipe}-${rowData.Aplicador}-${rowData.ATM}`;
                if (lancamentos.some(l => l.chave === chave)) return;
                
                const [y, m, d] = sessaoData.split('-');
                lancamentos.push({
                    chave, data: sessaoData, data_fmt: `${d}/${m}/${y}`, equipe: sessaoEquipe,
                    aplicador: rowData.Aplicador, atomizador: rowData.ATM,
                    gasolina: parseFloat(rowData.Gasolina) || 0,
                    inseticida: parseFloat(rowData.INS) || 0,
                    status: 'ready'
                });
                addedCount++;
            });

            renderLancamentos();
            toggleGenericModal('review-modal', false);
            showToast(`${addedCount} novos lançamentos adicionados!`, 'success');
        });

        // --- Funções de Auth (esqueci a senha, etc) ---
        selectors.sendResetBtn.addEventListener('click', () => {
            const email = document.getElementById('forgot-email').value;
            selectors.resetError.textContent = '';
            selectors.sendResetBtn.disabled = true;
            auth.sendPasswordResetEmail(email)
                .then(() => { showToast('Link de redefinição enviado!', 'success'); showAuthView('login-view'); })
                .catch(err => selectors.resetError.textContent = 'Erro ao enviar. Verifique o e-mail.')
                .finally(() => selectors.sendResetBtn.disabled = false);
        });

        selectors.changePasswordBtn.addEventListener('click', () => {
            const newPassword = document.getElementById('new-password').value;
            selectors.changePasswordError.textContent = '';
            if (newPassword.length < 6) return selectors.changePasswordError.textContent = 'A senha deve ter no mínimo 6 caracteres.';
            
            const user = auth.currentUser;
            if (!user) return;
            selectors.changePasswordBtn.disabled = true;
            user.updatePassword(newPassword)
                .then(() => { showToast('Senha alterada com sucesso!', 'success'); auth.signOut(); })
                .catch(err => selectors.changePasswordError.textContent = 'Erro ao alterar a senha. Tente novamente.')
                .finally(() => selectors.changePasswordBtn.disabled = false);
        });
    });
</script>
</body>
</html>
